{% extends "buch/base.html" %}
{% load static %}

{% block title %}Übersicht{% endblock %}

{% block content %}
<h2>Übersicht</h2>

{# --------------------------------------------------------- #}
{# Tabs: Übersicht / Benachrichtigungen                     #}
{# --------------------------------------------------------- #}

<div style="margin-bottom: 15px;">
    <button type="button"
            class="btn"
            id="tab-overview-btn">
        Übersicht
    </button>

    {% if is_admin_or_meister %}
        <button type="button"
                class="btn"
                id="tab-notifications-btn">
            Benachrichtigungen
            {% if notifications_count %}
                ({{ notifications_count }})
            {% endif %}
        </button>
    {% endif %}
</div>

{# --------------------------------------------------------- #}
{# TAB 1: Übersicht (Dashboard)                             #}
{# --------------------------------------------------------- #}

<div id="tab-overview" style="display: block;">

    <!-- Statistiken oben -->
    <div class="stats">
        <div class="stat-box">
            <div class="stat-label">Einträge heute</div>
            <div class="stat-value">{{ entries_today }}</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">Einträge diese Woche</div>
            <div class="stat-value">{{ entries_week }}</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">Offene Einträge</div>
            <div class="stat-value">{{ open_entries }}</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">Erledigte Einträge</div>
            <div class="stat-value">{{ done_entries }}</div>
        </div>
    </div>

    <hr>

    <!-- Diagramme -->
    <h3>Statistiken</h3>

    <div style="display: flex; flex-wrap: wrap; gap: 20px;">
        <div style="flex: 1 1 300px; min-width: 260px;">
            <h4>Status-Verteilung</h4>
            <canvas id="statusChart"></canvas>
        </div>

        <div style="flex: 1 1 300px; min-width: 260px;">
            <h4>Einträge (letzte 7 Tage)</h4>
            <canvas id="dateChart"></canvas>
        </div>
    </div>

    <hr>

    <h3>Einträge der letzten 7 Tage</h3>

    <div class="table-wrapper">
        <table>
            <thead>
            <tr>
                <th>Datum</th>
                <th>Schicht</th>
                <th>Maschine</th>
                <th>Titel</th>
                <th>Status</th>
                <th>Mitarbeiter</th>
            </tr>
            </thead>
            <tbody>
            {% for entry in entries %}
                <tr onclick="window.location='{% url 'entry_detail' entry.id %}'"
                    style="cursor: pointer;">
                    <td>{{ entry.date }}</td>
                    <td>{{ entry.get_shift_display }}</td>
                    <td>{{ entry.machine }}</td>
                    <td>{{ entry.title }}</td>
                    <td class="status-{{ entry.status }}">
                        {{ entry.get_status_display }}
                    </td>
                    <td>{{ entry.user.username }}</td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="6"><em>Keine Einträge vorhanden.</em></td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    {# Pagination für die Einträge-Liste #}
    {% if is_paginated %}
        <div class="pagination"
             style="margin-top: 10px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
            {% if page_obj.has_previous %}
                <a href="?page={{ page_obj.previous_page_number }}" class="btn">« Zurück</a>
            {% endif %}

            <span>
                Seite {{ page_obj.number }} von {{ page_obj.paginator.num_pages }}
            </span>

            {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}" class="btn">Weiter »</a>
            {% endif %}
        </div>
    {% endif %}

    <p style="margin-top: 15px;">
        <a href="{% url 'new_entry' %}" class="btn btn-primary">Neuer Eintrag</a>
    </p>
</div>


{# --------------------------------------------------------- #}
{# TAB 2: Benachrichtigungen (nur für Meister/Admin)        #}
{# --------------------------------------------------------- #}

{% if is_admin_or_meister %}
    <div id="tab-notifications" style="display: none; margin-top: 10px;">
        <h3>Benachrichtigungen – offene Ersatzteil-Buchungen</h3>

        {% if notifications %}
            <div class="table-wrapper">
                <table>
                    <thead>
                    <tr>
                        <th>Datum</th>
                        <th>Schicht</th>
                        <th>Maschine</th>
                        <th>Titel</th>
                        <th>Mitarbeiter</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for entry in notifications %}
                        <tr onclick="window.location='{% url 'entry_detail' entry.id %}'"
                            style="cursor: pointer;">
                            <td>{{ entry.date }}</td>
                            <td>{{ entry.get_shift_display }}</td>
                            <td>{{ entry.machine }}</td>
                            <td>{{ entry.title }}</td>
                            <td>{{ entry.user.username }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <p><em>Keine offenen Ersatzteil-Buchungen vorhanden.</em></p>
        {% endif %}
    </div>
{% endif %}


{# --------------------------------------------------------- #}
{# Chart.js (lokale Datei, kein Internet)                   #}
{# --------------------------------------------------------- #}

<script src="{% static 'js/chart.umd.js' %}"></script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // -------------------------------------------------
        // Tabs: Umschalten zwischen Übersicht / Benachrichtigungen
        // -------------------------------------------------
        const tabOverviewBtn = document.getElementById("tab-overview-btn");
        const tabNotificationsBtn = document.getElementById("tab-notifications-btn");
        const tabOverview = document.getElementById("tab-overview");
        const tabNotifications = document.getElementById("tab-notifications");

        if (tabOverviewBtn && tabOverview) {
            tabOverviewBtn.addEventListener("click", function () {
                tabOverview.style.display = "block";
                if (tabNotifications) {
                    tabNotifications.style.display = "none";
                }
            });
        }

        if (tabNotificationsBtn && tabNotifications && tabOverview) {
            tabNotificationsBtn.addEventListener("click", function () {
                tabOverview.style.display = "none";
                tabNotifications.style.display = "block";
            });
        }

        // -------------------------------------------------
        // Status-Diagramm (Doughnut)
        // -------------------------------------------------
        const statusLabels = {{ status_labels_json|safe }};
        const statusData = {{ status_data_json|safe }};

        const statusCanvas = document.getElementById('statusChart');
        if (statusCanvas && typeof Chart !== "undefined") {
            const statusCtx = statusCanvas.getContext('2d');
            new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: statusLabels,
                    datasets: [{
                        data: statusData,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        // -------------------------------------------------
        // Einträge pro Tag (letzte 7 Tage) – Balkendiagramm
        // -------------------------------------------------
        const dateLabels = {{ date_labels_json|safe }};
        const dateData = {{ date_data_json|safe }};

        const dateCanvas = document.getElementById('dateChart');
        if (dateCanvas && typeof Chart !== "undefined") {
            const dateCtx = dateCanvas.getContext('2d');
            new Chart(dateCtx, {
                type: 'bar',
                data: {
                    labels: dateLabels,
                    datasets: [{
                        label: 'Einträge',
                        data: dateData,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }
    });
</script>
{% endblock %}