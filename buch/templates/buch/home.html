{% extends "buch/base.html" %}
{% load static %}

{% block title %}√úbersicht{% endblock %}

{% block content %}

{# --------------------------------------------------------- #}
{# Lokales CSS nur f√ºr die Filter-UI                        #}
{# --------------------------------------------------------- #}
<style>
    .filter-panel {
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background: var(--card-bg);
        padding: 10px 12px;
        margin-bottom: 10px;
    }

    .filter-panel__header {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        cursor: pointer;
    }

    .filter-panel__title {
        font-weight: 600;
        font-size: 14px;
    }

    .filter-panel__meta {
        font-size: 12px;
        color: var(--muted-text);
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        align-items: center;
    }

    .filter-chip {
        display: inline-flex;
        align-items: center;
        padding: 2px 6px;
        border-radius: 999px;
        background: rgba(0, 123, 255, 0.08);
        border: 1px solid rgba(0, 123, 255, 0.35);
        font-size: 11px;
        color: var(--button-text);
        white-space: nowrap;
    }

    .filter-chip--count {
        background: rgba(0, 0, 0, 0.04);
        border-color: var(--border-color);
    }

    .filter-panel__icon {
        font-size: 14px;
        opacity: 0.8;
    }

    .filter-panel__body {
        margin-top: 10px;
    }

    .filter-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 8px;
        align-items: flex-end;
    }

    .filter-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        align-items: center;
        margin-top: 4px;
    }

    /* kompaktere Inputs im Filter-Bereich, besonders f√ºr Handy */
    .filter-panel input,
    .filter-panel select {
        font-size: 14px;
        padding: 6px 8px;
    }

    .filter-panel label {
        font-size: 13px;
        margin-bottom: 2px;
    }

    @media (max-width: 600px) {
        .filter-grid {
            grid-template-columns: 1fr 1fr;
        }

        .filter-actions {
            grid-column: 1 / -1;
        }
    }
</style>

<h2>√úbersicht</h2>

{# --------------------------------------------------------- #}
{# Tabs: √úbersicht / Statistiken / Benachrichtigungen       #}
{# --------------------------------------------------------- #}

<div style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
    <button type="button" class="btn" id="tab-overview-btn">√úbersicht</button>
    <button type="button" class="btn" id="tab-stats-btn">Statistiken</button>

    {% if is_admin_or_meister %}
        <button type="button" class="btn" id="tab-notifications-btn">
            Benachrichtigungen
            {% if notifications_count %}
                ({{ notifications_count }})
            {% endif %}
        </button>
    {% endif %}
</div>

{# --------------------------------------------------------- #}
{# TAB 1: √úbersicht ‚Äì moderner Filter + Liste               #}
{# --------------------------------------------------------- #}

<div id="tab-overview" style="display: block;">

    <h3>Eintr√§ge (neueste zuerst)</h3>

    {# Zusammenfassung / Trefferzahl #}
    <p style="font-size: 13px; color: var(--muted-text); margin-bottom: 6px;">
        Gefundene Eintr√§ge: {{ page_obj.paginator.count }}
        {% if filters_active %}
            ‚Äì <strong>Filter aktiv</strong>
        {% else %}
            ‚Äì keine Filter aktiv
        {% endif %}
    </p>

    {# Moderner, einklappbarer Filter-Block #}
    <div class="filter-panel">

        <div class="filter-panel__header" id="filter-header">
            <div class="filter-panel__title">
                üîç Filter &amp; Suche
            </div>
            <div class="filter-panel__meta">
                <span class="filter-chip filter-chip--count">
                    Seite {{ page_obj.number }} / {{ page_obj.paginator.num_pages }} ‚Äì {{ per_page }} pro Seite
                </span>

                {% if filters_active %}
                    <span class="filter-chip">
                        Aktive Filter
                    </span>
                    {% if filter_search %}
                        <span class="filter-chip">Titel: ‚Äû{{ filter_search }}‚Äú</span>
                    {% endif %}
                    {% if filter_machine %}
                        <span class="filter-chip">Maschine</span>
                    {% endif %}
                    {% if filter_status %}
                        <span class="filter-chip">Status</span>
                    {% endif %}
                    {% if filter_shift %}
                        <span class="filter-chip">Schicht</span>
                    {% endif %}
                    {% if filter_category %}
                        <span class="filter-chip">Kategorie</span>
                    {% endif %}
                    {% if filter_date_from or filter_date_to %}
                        <span class="filter-chip">Zeitraum</span>
                    {% endif %}
                {% else %}
                    <span style="font-size: 12px;">Keine Filter gesetzt</span>
                {% endif %}

                <span class="filter-panel__icon" id="filter-toggle-icon">
                    {% if filters_active %}‚ñ≤{% else %}‚ñº{% endif %}
                </span>
            </div>
        </div>

        <div class="filter-panel__body"
             id="filter-container"
             style="{% if filters_active %}display: block;{% else %}display: none;{% endif %}">

            <form method="get" class="filter-grid">

                <div>
                    <label for="search_input">Titel-Suche</label>
                    <input type="text"
                           id="search_input"
                           name="search"
                           value="{{ filter_search }}"
                           placeholder="Titel enth√§lt ‚Ä¶">
                </div>

                <div>
                    <label for="machine_select">Maschine</label>
                    <select id="machine_select" name="machine">
                        <option value="">Alle</option>
                        {% for m in machines %}
                            <option value="{{ m.id }}"
                                    {% if filter_machine|default_if_none:'' == m.id|stringformat:"s" %}selected{% endif %}>
                                {{ m.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label for="status_select">Status</label>
                    <select id="status_select" name="status">
                        <option value="">Alle</option>
                        {% for code, label in status_choices %}
                            <option value="{{ code }}"
                                    {% if filter_status == code %}selected{% endif %}>
                                {{ label }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label for="shift_select">Schicht</label>
                    <select id="shift_select" name="shift">
                        <option value="">Alle</option>
                        {% for code, label in shift_choices %}
                            <option value="{{ code }}"
                                    {% if filter_shift == code %}selected{% endif %}>
                                {{ label }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label for="category_select">Kategorie</label>
                    <select id="category_select" name="category">
                        <option value="">Alle</option>
                        {% for code, label in category_choices %}
                            <option value="{{ code }}"
                                    {% if filter_category == code %}selected{% endif %}>
                                {{ label }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label for="date_from">Datum von</label>
                    <input type="date"
                           id="date_from"
                           name="date_from"
                           value="{{ filter_date_from }}">
                </div>

                <div>
                    <label for="date_to">Datum bis</label>
                    <input type="date"
                           id="date_to"
                           name="date_to"
                           value="{{ filter_date_to }}">
                </div>

                <div>
                    <label for="per_page_select">Eintr√§ge pro Seite</label>
                    <select id="per_page_select"
                            name="per_page"
                            onchange="this.form.submit()">
                        {% for option in per_page_options %}
                            <option value="{{ option }}"
                                    {% if per_page == option %}selected{% endif %}>
                                {{ option }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="filter-actions">
                    <button type="submit" class="btn btn-primary">Filter anwenden</button>
                    <a href="{% url 'home' %}" class="btn">Zur√ºcksetzen</a>
                </div>
            </form>
        </div>
    </div>

    <div class="table-wrapper">
        <table>
            <thead>
            <tr>
                <th>Datum</th>
                <th>Schicht</th>
                <th>Maschine</th>
                <th>Titel</th>
                <th>Status</th>
                <th>Mitarbeiter</th>
            </tr>
            </thead>
            <tbody>
            {% for entry in entries %}
                <tr onclick="window.location='{% url 'entry_detail' entry.id %}'"
                    style="cursor: pointer;">
                    <td>{{ entry.date }}</td>
                    <td>{{ entry.get_shift_display }}</td>
                    <td>{{ entry.machine }}</td>
                    <td>{{ entry.title }}</td>
                    <td class="status-{{ entry.status }}">
                        {{ entry.get_status_display }}
                    </td>
                    <td>{{ entry.user.username }}</td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="6"><em>Keine Eintr√§ge gefunden.</em></td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    {# Pagination: Filter & per_page in Links erhalten #}
    {% if is_paginated %}
        <div class="pagination"
             style="margin-top: 10px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">

            {% if page_obj.has_previous %}
                <a href="?page={{ page_obj.previous_page_number }}
                         &per_page={{ per_page }}
                         {% if filter_search %}&search={{ filter_search|urlencode }}{% endif %}
                         {% if filter_machine %}&machine={{ filter_machine }}{% endif %}
                         {% if filter_status %}&status={{ filter_status }}{% endif %}
                         {% if filter_shift %}&shift={{ filter_shift }}{% endif %}
                         {% if filter_category %}&category={{ filter_category }}{% endif %}
                         {% if filter_date_from %}&date_from={{ filter_date_from }}{% endif %}
                         {% if filter_date_to %}&date_to={{ filter_date_to }}{% endif %}"
                   class="btn">¬´ Zur√ºck</a>
            {% endif %}

            <span>
                Seite {{ page_obj.number }} von {{ page_obj.paginator.num_pages }}
            </span>

            {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}
                         &per_page={{ per_page }}
                         {% if filter_search %}&search={{ filter_search|urlencode }}{% endif %}
                         {% if filter_machine %}&machine={{ filter_machine }}{% endif %}
                         {% if filter_status %}&status={{ filter_status }}{% endif %}
                         {% if filter_shift %}&shift={{ filter_shift }}{% endif %}
                         {% if filter_category %}&category={{ filter_category }}{% endif %}
                         {% if filter_date_from %}&date_from={{ filter_date_from }}{% endif %}
                         {% if filter_date_to %}&date_to={{ filter_date_to }}{% endif %}"
                   class="btn">Weiter ¬ª</a>
            {% endif %}
        </div>
    {% endif %}

    <p style="margin-top: 15px;">
        <a href="{% url 'new_entry' %}" class="btn btn-primary">Neuer Eintrag</a>
    </p>
</div>


{# --------------------------------------------------------- #}
{# TAB 2: Statistiken (Kacheln + Diagramme)                 #}
{# --------------------------------------------------------- #}

<div id="tab-stats" style="display: none; margin-top: 10px;">

    <h3>Statistik ‚Äì √úbersicht</h3>

    <div class="stats">
        <div class="stat-box">
            <div class="stat-label">Eintr√§ge heute</div>
            <div class="stat-value">{{ entries_today }}</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">Eintr√§ge diese Woche</div>
            <div class="stat-value">{{ entries_week }}</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">Offene Eintr√§ge</div>
            <div class="stat-value">{{ open_entries }}</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">Erledigte Eintr√§ge</div>
            <div class="stat-value">{{ done_entries }}</div>
        </div>
    </div>

    <hr>

    <h3>Diagramme</h3>

    <div style="display: flex; flex-wrap: wrap; gap: 20px;">
        <div style="flex: 1 1 300px; min-width: 260px;">
            <h4>Status-Verteilung</h4>
            <canvas id="statusChart"></canvas>
        </div>

        <div style="flex: 1 1 300px; min-width: 260px;">
            <h4>Eintr√§ge (letzte 7 Tage)</h4>
            <canvas id="dateChart"></canvas>
        </div>
    </div>

</div>


{# --------------------------------------------------------- #}
{# TAB 3: Benachrichtigungen (nur Meister/Admin)            #}
{# --------------------------------------------------------- #}

{% if is_admin_or_meister %}
    <div id="tab-notifications" style="display: none; margin-top: 10px;">
        <h3>Benachrichtigungen ‚Äì offene Ersatzteil-Buchungen</h3>

        {% if notifications %}
            <div class="table-wrapper">
                <table>
                    <thead>
                    <tr>
                        <th>Datum</th>
                        <th>Schicht</th>
                        <th>Maschine</th>
                        <th>Titel</th>
                        <th>Mitarbeiter</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for entry in notifications %}
                        <tr onclick="window.location='{% url 'entry_detail' entry.id %}'"
                            style="cursor: pointer;">
                            <td>{{ entry.date }}</td>
                            <td>{{ entry.get_shift_display }}</td>
                            <td>{{ entry.machine }}</td>
                            <td>{{ entry.title }}</td>
                            <td>{{ entry.user.username }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <p><em>Keine offenen Ersatzteil-Buchungen vorhanden.</em></p>
        {% endif %}
    </div>
{% endif %}


{# --------------------------------------------------------- #}
{# Chart.js (lokale Datei)                                  #}
{# --------------------------------------------------------- #}

<script src="{% static 'js/chart.umd.js' %}"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {

    // -------------------------------------------------
    // Tabs Initialisierung
    // -------------------------------------------------
    const tabOverview = document.getElementById("tab-overview");
    const tabStats = document.getElementById("tab-stats");
    const tabNotifications = document.getElementById("tab-notifications");

    const btnOverview = document.getElementById("tab-overview-btn");
    const btnStats = document.getElementById("tab-stats-btn");
    const btnNotifications = document.getElementById("tab-notifications-btn");

    function hideAllTabs() {
        if (tabOverview) tabOverview.style.display = "none";
        if (tabStats) tabStats.style.display = "none";
        if (tabNotifications) tabNotifications.style.display = "none";
    }

    if (btnOverview) {
        btnOverview.addEventListener("click", () => {
            hideAllTabs();
            tabOverview.style.display = "block";
        });
    }

    if (btnStats) {
        btnStats.addEventListener("click", () => {
            hideAllTabs();
            tabStats.style.display = "block";
        });
    }

    if (btnNotifications && tabNotifications) {
        btnNotifications.addEventListener("click", () => {
            hideAllTabs();
            tabNotifications.style.display = "block";
        });
    }

    // -------------------------------------------------
    // Filter ein-/ausblenden (Header klickbar)         #
    // -------------------------------------------------
    const filterHeader = document.getElementById("filter-header");
    const filterContainer = document.getElementById("filter-container");
    const filterToggleIcon = document.getElementById("filter-toggle-icon");

    if (filterHeader && filterContainer) {
        filterHeader.addEventListener("click", function (e) {
            // nicht ausl√∂sen, wenn innerhalb des Formulars auf Inputs geklickt wird
            if (e.target.tagName === "SELECT" || e.target.tagName === "INPUT" || e.target.tagName === "BUTTON" || e.target.tagName === "A") {
                return;
            }
            const isHidden = filterContainer.style.display === "none" || filterContainer.style.display === "";
            if (isHidden) {
                filterContainer.style.display = "block";
                if (filterToggleIcon) filterToggleIcon.textContent = "‚ñ≤";
            } else {
                filterContainer.style.display = "none";
                if (filterToggleIcon) filterToggleIcon.textContent = "‚ñº";
            }
        });
    }

    // -------------------------------------------------
    // Status-Diagramm
    // -------------------------------------------------
    const statusLabels = {{ status_labels_json|safe }};
    const statusData = {{ status_data_json|safe }};

    const statusCanvas = document.getElementById('statusChart');
    if (statusCanvas && typeof Chart !== "undefined") {
        const ctx = statusCanvas.getContext('2d');
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: statusLabels,
                datasets: [{
                    data: statusData,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { position: 'bottom' } }
            }
        });
    }

    // -------------------------------------------------
    // 7-Tage-Diagramm
    // -------------------------------------------------
    const dateLabels = {{ date_labels_json|safe }};
    const dateData = {{ date_data_json|safe }};

    const dateCanvas = document.getElementById('dateChart');
    if (dateCanvas && typeof Chart !== "undefined") {
        const ctx = dateCanvas.getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: dateLabels,
                datasets: [{
                    label: 'Eintr√§ge',
                    data: dateData,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: { y: { beginAtZero: true } }
            }
        });
    }

});
</script>

{% endblock %}