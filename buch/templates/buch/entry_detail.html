{% extends "buch/base.html" %}

{% block title %}Eintrag Details{% endblock %}

{% block content %}
<h2>Schichtbucheintrag</h2>

<table>
    <tr>
        <th>Datum</th>
        <td>{{ entry.date }}</td>
    </tr>
    <tr>
        <th>Uhrzeit</th>
        <td>
            {% if entry.time %}
                {{ entry.time }}
            {% else %}
                -
            {% endif %}
        </td>
    </tr>
    <tr>
        <th>Schicht</th>
        <td>{{ entry.get_shift_display }}</td>
    </tr>
    <tr>
        <th>Maschine</th>
        <td>{{ entry.machine }}</td>
    </tr>
    <tr>
        <th>Kategorie</th>
        <td>{{ entry.get_category_display }}</td>
    </tr>
    <tr>
        <th>Status</th>
        <td class="status-{{ entry.status }}">
            {{ entry.get_status_display }}
        </td>
    </tr>
    <tr>
        <th>Dauer (min)</th>
        <td>
            {% if entry.duration_minutes %}
                {{ entry.duration_minutes }}
            {% else %}
                -
            {% endif %}
        </td>
    </tr>
    <tr>
        <th>PrioritÃ¤t</th>
        <td>{{ entry.priority }}</td>
    </tr>
    <tr>
        <th>Mitarbeiter</th>
        <td>{{ entry.user.username }}</td>
    </tr>
</table>

<h3>Titel</h3>
<p><strong>{{ entry.title }}</strong></p>

<h3>Beschreibung</h3>
<p>{{ entry.description|linebreaks }}</p>


{# --------------------------------------------------------- #}
{# Ersatzteile + SAP-Bearbeitungsstatus                      #}
{# --------------------------------------------------------- #}

{% if entry.has_any_spare_parts and can_view_spares %}
    <h3>Ersatzteile</h3>

    {# Alte, einfache Felder (fÃ¼r Bestandsdaten) #}
    {% if entry.used_spare_parts %}
        <h4>Alte Ersatzteil-Angaben</h4>
        <table>
            <tr>
                <th>Beschreibung</th>
                <td>{{ entry.spare_part_description }}</td>
            </tr>
            <tr>
                <th>SAP-Nummer</th>
                <td>{{ entry.spare_part_sap_number }}</td>
            </tr>
            <tr>
                <th>Entnommene Anzahl</th>
                <td>{{ entry.spare_part_quantity_used }}</td>
            </tr>
            <tr>
                <th>Bestand nach Entnahme</th>
                <td>{{ entry.spare_part_quantity_remaining }}</td>
            </tr>
        </table>
    {% endif %}

    {# Strukturierte Ersatzteile (SparePart-Modell) #}
    {% if entry.spare_parts.all %}
        <h4>Strukturierte Ersatzteile</h4>
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>SAP-Nummer</th>
                        <th>Beschreibung</th>
                        <th>Entnommene Anzahl</th>
                        <th>Bestand nach Entnahme</th>
                        <th>Erfasst von</th>
                        <th>Erfasst am</th>
                    </tr>
                </thead>
                <tbody>
                    {% for part in entry.spare_parts.all %}
                        <tr>
                            <td>{{ part.sap_number }}</td>
                            <td>{{ part.description }}</td>
                            <td>{{ part.quantity_used }}</td>
                            <td>{{ part.quantity_remaining }}</td>
                            <td>
                                {% if part.created_by %}
                                    {{ part.created_by.username }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>{{ part.created_at|date:"d.m.Y H:i" }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% endif %}

    {# SAP-Bearbeitung #}
    <h4>Verbuchung in SAP</h4>

    {% if can_process_spares %}
        <form method="post"
              action="{% url 'toggle_spare_parts_processed' entry.id %}"
              style="margin-top:8px; margin-bottom:10px;">
            {% csrf_token %}
            <label>
                <input type="checkbox"
                       name="processed"
                       onchange="this.form.submit()"
                       {% if entry.spare_parts_processed %}checked{% endif %}>
                Entnahme in SAP verbucht
            </label>

            {% if entry.spare_parts_processed %}
                <div style="font-size:12px; color: var(--muted-text, #666); margin-top:4px;">
                    BestÃ¤tigt
                    {% if entry.spare_parts_processed_by %}
                        von {{ entry.spare_parts_processed_by.username }}
                    {% endif %}
                    {% if entry.spare_parts_processed_at %}
                        am {{ entry.spare_parts_processed_at|date:"d.m.Y H:i" }}
                    {% endif %}
                </div>
            {% endif %}
        </form>
    {% else %}
        {% if entry.spare_parts_processed %}
            <p><em>
                Die Entnahme wurde in SAP verbucht.
                {% if entry.spare_parts_processed_at %}
                    ({{ entry.spare_parts_processed_at|date:"d.m.Y H:i" }})
                {% endif %}
                {% if entry.spare_parts_processed_by %}
                    durch {{ entry.spare_parts_processed_by.username }}
                {% endif %}
            </em></p>
        {% else %}
            <p><em>Die Entnahme ist noch nicht in SAP als bearbeitet markiert.</em></p>
        {% endif %}
    {% endif %}

{% elif entry.has_any_spare_parts %}
    {# Es wurden Ersatzteile verwendet, aber Benutzer darf Details nicht sehen #}
    <p><em>
        Ersatzteile wurden verwendet. Details sind nur fÃ¼r Meister/Admin,
        den Ersteller oder Benutzer mit ErgÃ¤nzungen zu diesem Eintrag sichtbar.
    </em></p>
{% endif %}


{# --------------------------------------------------------- #}
{# Bilder                                                    #}
{# --------------------------------------------------------- #}

{% if entry.images.all %}
    <h3>Bilder</h3>
    {% for img in entry.images.all %}
        <div style="margin-bottom:15px;">
            <img src="{{ img.image.url }}" style="max-width:100%; max-height:500px;">
            {% if img.comment %}
                <p><em>{{ img.comment }}</em></p>
            {% endif %}
        </div>
    {% endfor %}
{% else %}
    <p><em>Keine Bilder vorhanden.</em></p>
{% endif %}


{# --------------------------------------------------------- #}
{# Videos                                                    #}
{# --------------------------------------------------------- #}

{% if entry.videos.all %}
    <h3>Videos</h3>
    {% for vid in entry.videos.all %}
        <div style="margin-bottom:15px;">
            <video controls style="max-width:100%; max-height:500px;">
                <source src="{{ vid.video.url }}">
                Dein Browser unterstÃ¼tzt das Video-Tag nicht.
            </video>
            {% if vid.comment %}
                <p><em>{{ vid.comment }}</em></p>
            {% endif %}
        </div>
    {% endfor %}
{% else %}
    <p><em>Keine Videos vorhanden.</em></p>
{% endif %}


{# --------------------------------------------------------- #}
{# ErgÃ¤nzungen / Historie                                    #}
{# --------------------------------------------------------- #}

{% if updates %}
    <h3>ErgÃ¤nzungen / Historie</h3>
    <ul>
        {% for upd in updates %}
            <li style="margin-bottom:10px;">
                <strong>{{ upd.action_time|date:"d.m.Y H:i" }}</strong>
                â€“ ergÃ¤nzt von {{ upd.user.username }}
                {% if upd.status_after and upd.status_after != upd.status_before %}
                    <br>
                    Status: {{ upd.get_status_before_display }} â†’ {{ upd.get_status_after_display }}
                {% endif %}
                <br>
                {{ upd.comment|linebreaks }}
            </li>
        {% endfor %}
    </ul>
{% endif %}


{# --------------------------------------------------------- #}
{# Likes                                                     #}
{# --------------------------------------------------------- #}

<form action="{% url 'toggle_like' entry.id %}" method="post" style="margin-top:15px;">
    {% csrf_token %}
    <button type="submit" class="btn">
        ğŸ‘ Like ({{ likes_count }})
    </button>
</form>


{# --------------------------------------------------------- #}
{# Aktionen                                                  #}
{# --------------------------------------------------------- #}

<p style="margin-top:15px;">
    <a href="{% url 'home' %}" class="btn">â† ZurÃ¼ck</a>
    <a href="{% url 'update_entry' entry.id %}" class="btn btn-primary">Eintrag ergÃ¤nzen</a>
</p>

{% endblock %}