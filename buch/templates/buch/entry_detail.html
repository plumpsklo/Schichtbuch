{% extends "buch/base.html" %}

{% block title %}Eintrag Details{% endblock %}

{% block content %}
<h2>Schichtbucheintrag</h2>

<style>
    /* kleine lokale Styles nur f√ºr die Detailseite */

    .entry-meta-table {
        margin-bottom: 16px;
    }

    .card {
        border: 1px solid var(--border-color);
        border-radius: 6px;
        background: var(--card-bg, #f9f9f9);
        padding: 10px 12px;
        margin: 10px 0 16px 0;
    }

    .card-header-line {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        margin-bottom: 8px;
        flex-wrap: wrap;
    }

    .badge {
        display: inline-flex;
        align-items: center;
        padding: 3px 8px;
        border-radius: 999px;
        font-size: 11px;
        font-weight: 600;
        white-space: nowrap;
    }

    .badge-warning {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffe08a;
    }

    .badge-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #a8e0b2;
    }

    .badge-muted {
        background: #e2e3e5;
        color: #555;
        border: 1px solid #d6d8db;
    }

    .sap-toggle-form {
        margin-top: 8px;
    }

    .sap-meta {
        margin-top: 4px;
        font-size: 12px;
        color: var(--muted-text);
    }

    .spareparts-summary {
        margin: 6px 0 4px 0;
        font-size: 13px;
        color: var(--muted-text);
    }

    @media (max-width: 600px) {
        .card-header-line h3 {
            margin-bottom: 4px;
        }
    }
</style>

<table class="entry-meta-table">
    <tr><th>Datum</th><td>{{ entry.date }}</td></tr>
    <tr><th>Uhrzeit</th>
        <td>
            {% if entry.time %}
                {{ entry.time }}
            {% else %}
                -
            {% endif %}
        </td>
    </tr>
    <tr><th>Schicht</th><td>{{ entry.get_shift_display }}</td></tr>
    <tr><th>Maschine</th><td>{{ entry.machine }}</td></tr>
    <tr><th>Kategorie</th><td>{{ entry.get_category_display }}</td></tr>
    <tr>
        <th>Status</th>
        <td class="status-{{ entry.status }}">
            {{ entry.get_status_display }}
        </td>
    </tr>
    <tr><th>Dauer (min)</th><td>{{ entry.duration_minutes }}</td></tr>
    <tr><th>Priorit√§t</th><td>{{ entry.priority }}</td></tr>
    <tr><th>Mitarbeiter</th><td>{{ entry.user.username }}</td></tr>
</table>

<h3>Titel</h3>
<p><strong>{{ entry.title }}</strong></p>

<h3>Beschreibung</h3>
<p>{{ entry.description|linebreaks }}</p>

{# --------------------------------------------------------- #}
{# Ersatzteile + SAP-Status                                  #}
{# --------------------------------------------------------- #}

{% if entry.used_spare_parts %}
    <div class="spareparts-summary">
        <strong>Ersatzteile verwendet.</strong>
        {% if can_view_spares %}
            Details siehe Abschnitt ‚ÄûErsatzteile‚Äú.
        {% else %}
            Details sind nur f√ºr berechtigte Benutzer sichtbar.
        {% endif %}
    </div>

    <div class="card">
        <div class="card-header-line">
            <h3 style="margin: 0;">Ersatzteile</h3>

            {# SAP-Status als Badge #}
            {% if entry.spare_parts_processed %}
                <span class="badge badge-success">SAP-Buchung erledigt</span>
            {% else %}
                <span class="badge badge-warning">SAP-Buchung offen</span>
            {% endif %}
        </div>

        {% if can_view_spares %}
            <table>
                <tr>
                    <th>Beschreibung</th>
                    <td>{{ entry.spare_part_description }}</td>
                </tr>
                <tr>
                    <th>SAP-Nummer</th>
                    <td>{{ entry.spare_part_sap_number }}</td>
                </tr>
                <tr>
                    <th>Entnommene Anzahl</th>
                    <td>{{ entry.spare_part_quantity_used }}</td>
                </tr>
                <tr>
                    <th>Bestand nach Entnahme</th>
                    <td>{{ entry.spare_part_quantity_remaining }}</td>
                </tr>
            </table>
        {% else %}
            <p><em>Ersatzteile wurden verwendet. Details sind nur f√ºr Meister/Admin oder den Ersteller sichtbar.</em></p>
        {% endif %}

        {# SAP-Status √§ndern ‚Äì nur f√ºr Meister/Admin (can_process_spares) #}
        {% if can_process_spares and entry.used_spare_parts %}
            <form action="{% url 'toggle_spare_parts_processed' entry.id %}"
                  method="post"
                  class="sap-toggle-form">
                {% csrf_token %}
                {% if entry.spare_parts_processed %}
                    <button type="submit" class="btn btn-danger">
                        SAP-Status auf ‚Äûoffen‚Äú zur√ºcksetzen
                    </button>
                {% else %}
                    <button type="submit" class="btn btn-primary">
                        SAP-Buchung als erledigt markieren
                    </button>
                {% endif %}
            </form>

            {% if entry.spare_parts_processed and entry.spare_parts_processed_by %}
                <p class="sap-meta">
                    Markiert als erledigt von {{ entry.spare_parts_processed_by.username }}
                    am {{ entry.spare_parts_processed_at|date:"d.m.Y H:i" }} Uhr.
                </p>
            {% endif %}
        {% endif %}
    </div>

{% endif %}

{# --------------------------------------------------------- #}
{# Bilder                                                    #}
{# --------------------------------------------------------- #}

{% if entry.images.all %}
    <h3>Bilder</h3>
    {% for img in entry.images.all %}
        <div style="margin-bottom:15px;">
            <img src="{{ img.image.url }}" style="max-width:100%; max-height:500px;">
            {% if img.comment %}
                <p><em>{{ img.comment }}</em></p>
            {% endif %}
        </div>
    {% endfor %}
{% else %}
    <p><em>Keine Bilder vorhanden.</em></p>
{% endif %}

{# --------------------------------------------------------- #}
{# Videos                                                    #}
{# --------------------------------------------------------- #}

{% if entry.videos.all %}
    <h3>Videos</h3>
    {% for vid in entry.videos.all %}
        <div style="margin-bottom:15px;">
            <video controls style="max-width:100%; max-height:500px;">
                <source src="{{ vid.video.url }}">
                Dein Browser unterst√ºtzt das Video-Tag nicht.
            </video>
            {% if vid.comment %}
                <p><em>{{ vid.comment }}</em></p>
            {% endif %}
        </div>
    {% endfor %}
{% else %}
    <p><em>Keine Videos vorhanden.</em></p>
{% endif %}

{# --------------------------------------------------------- #}
{# Historie / Erg√§nzungen                                    #}
{# --------------------------------------------------------- #}

{% if entry.updates.all %}
    <h3>Erg√§nzungen / Historie</h3>
    <ul>
        {% for upd in entry.updates.all %}
            <li style="margin-bottom:10px;">
                <strong>{{ upd.action_time|date:"d.m.Y H:i" }}</strong>
                ‚Äì erg√§nzt von {{ upd.user.username }}
                {% if upd.status_after and upd.status_after != upd.status_before %}
                    <br>
                    Status: {{ upd.get_status_before_display }} ‚Üí {{ upd.get_status_after_display }}
                {% endif %}
                <br>
                {{ upd.comment|linebreaks }}
            </li>
        {% endfor %}
    </ul>
{% endif %}

{# --------------------------------------------------------- #}
{# Like-Button                                               #}
{# --------------------------------------------------------- #}

<form action="{% url 'toggle_like' entry.id %}" method="post" style="margin-top:15px;">
    {% csrf_token %}
    <button type="submit" class="btn">
        üëç Like ({{ entry.likes.count }})
    </button>
</form>

<p style="margin-top: 10px;">
    <a href="{% url 'home' %}" class="btn">‚Üê Zur√ºck</a>
    <a href="{% url 'update_entry' entry.id %}" class="btn btn-primary">Eintrag erg√§nzen</a>
</p>

{% endblock %}